# TPC-H how-to

## 准备`tpch-dbgen`

`git clone https://github.com/electrum/tpch-dbgen`到本地；

在`makefile`里按需修改如下行：
```
DATABASE = HSQLDB
MACHINE = MAC
WORKLOAD = TPCH
```

在`tpcd.h`里追加如下行：
```c
#ifdef HSQLDB
#define GEN_QUERY_PLAN ""
#define START_TRAN "START TRANSACTION\n"
#define END_TRAN "COMMIT\n"
#define SET_OUTPUT ""
#define SET_ROWCOUNT ""
#define SET_DBASE ""
#endif
```

在`dss.ddl`里把所有`TABLE`改为`CACHED TABLE`；

将`dss.ri`替换为：
```
ALTER TABLE REGION ADD PRIMARY KEY (R_REGIONKEY);
ALTER TABLE NATION ADD PRIMARY KEY (N_NATIONKEY);
ALTER TABLE NATION ADD FOREIGN KEY (N_REGIONKEY) references REGION; COMMIT WORK;
ALTER TABLE PART ADD PRIMARY KEY (P_PARTKEY); COMMIT WORK;
ALTER TABLE SUPPLIER ADD PRIMARY KEY (S_SUPPKEY);
ALTER TABLE SUPPLIER ADD FOREIGN KEY (S_NATIONKEY) references NATION; COMMIT WORK;
ALTER TABLE PARTSUPP ADD PRIMARY KEY (PS_PARTKEY,PS_SUPPKEY); COMMIT WORK;
ALTER TABLE CUSTOMER ADD PRIMARY KEY (C_CUSTKEY);
ALTER TABLE CUSTOMER ADD FOREIGN KEY (C_NATIONKEY) references NATION; COMMIT WORK;
ALTER TABLE LINEITEM ADD PRIMARY KEY (L_ORDERKEY,L_LINENUMBER); COMMIT WORK;
ALTER TABLE ORDERS ADD PRIMARY KEY (O_ORDERKEY); COMMIT WORK;
ALTER TABLE PARTSUPP ADD FOREIGN KEY (PS_SUPPKEY) references SUPPLIER; COMMIT WORK;
ALTER TABLE PARTSUPP ADD FOREIGN KEY (PS_PARTKEY) references PART; COMMIT WORK;
ALTER TABLE ORDERS ADD FOREIGN KEY (O_CUSTKEY) references CUSTOMER; COMMIT WORK;
ALTER TABLE LINEITEM ADD FOREIGN KEY (L_ORDERKEY)  references ORDERS; COMMIT WORK;
ALTER TABLE LINEITEM ADD FOREIGN KEY (L_PARTKEY,L_SUPPKEY) references PARTSUPP; COMMIT WORK;
```

编译：`make`

## 使用`do.py`

配置`__TPCH_DBGEN_PATH__`为上步目录，配置`__OUTPUT_PATH__`为输出目录，配置`__SCALE_FACTOR__`为`SF`值，配置`__JAVA_CMD__`为运行java测试所需的命令及参数，如果没有，注释掉。

仅测试`Python 3.5.2`，执行即可。

## 测试HSQLDB

编辑`org.hsqldb.sample Testdb.java`文件，将`prefix`修改为`__OUTPUT_PATH__`指向目录，运行。

## 例测试环境配置

- 电脑：`MacBook Pro`
- OS：`macOS Sierra 10.12.5`
- CPU：`2.8 GHz Intel Core i7`
- RAM：`16GB 1600 MHz DDR3`
- 硬盘：`APPLE SSD SM0512F (PCI)`
- HSQLDB：`2.3.0`
- Java：`1.8._092`
- Python：`3.5.2`

## 例测试结果

某次运行后`__OUTPUT_PATH__/%timestamp%/javastdout.txt`如下（所有数据以毫秒为单位）：
```
Load:1469841
RF1:2635
Q1:24564
Q2:18594
Q3:13718
Q4:6853
Q5:30581
Q6:19450
Q8:32535
Q9:264225
Q10:16140
Q11:10221
Q12:33449
Q13:13355
Q14:23175
Q15:67843
Q16:6377
Q17:161256
Q18:344487
Q19:191939
Q20:1558
Q22:2955
RF2:2322
```

根据`TPC-H`标准，有
$$
\text{TPC-H Power@1GB}=\frac{3600*1}{\sqrt[24]{\prod^{i=22}_{i=1}{QI(i,0)}*\prod^{j=2}_{j=1}{RI(j,0)}}}
$$

计算得$$\text{TPC-H Power@1GB}=178.7783939015134$$。
